# encoding=utf-8

require "spec_helper"

shared_examples_for "draft-75 parser" do
  before do
    @message = ""
    @parser.onmessage { |message| @message += message }
  end

  it "parses text frames" do
    parse [0x00, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0xff]
    @message.should == "Hello"
  end

  it "parses multiple frames from the same packet" do
    parse [0x00, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0xff, 0x00, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0xff]
    @message.should == "HelloHello"
  end

  it "parses text frames beginning 0x00-0x7F" do
    parse [0x66, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0xff]
    @message.should == "Hello"
  end

  it "ignores frames with a length header" do
    parse [0x80, 0x02, 0x48, 0x65, 0x00, 0x48, 0x65, 0x6c, 0x6c, 0x6f, 0xff]
    @message.should == "Hello"
  end

  it "parses multibyte text frames" do
    parse [0x00, 0x41, 0x70, 0x70, 0x6c, 0x65, 0x20, 0x3d, 0x20, 0xef, 0xa3, 0xbf, 0xff]
    @message.should == encode("Apple = ")
  end

  it "parses frames received in several packets" do
    parse [0x00, 0x41, 0x70, 0x70, 0x6c, 0x65]
    parse [0x20, 0x3d, 0x20, 0xef, 0xa3, 0xbf, 0xff]
    @message.should == encode("Apple = ")
  end

  it "parses fragmented frames" do
    parse [0x00, 0x48, 0x65, 0x6c]
    parse [0x6c, 0x6f, 0xff]
    @message.should == "Hello"
  end
end

